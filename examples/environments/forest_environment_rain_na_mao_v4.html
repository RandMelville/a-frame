<!DOCTYPE html>
<html>

<head>
  <title>Chuva com A-Frame</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
</head>

<body>
  <a-scene environment="preset: forest">
    <a-camera></a-camera>
    <a-entity id="rain"></a-entity>

    <div id="messageBox"
      style="position: fixed; top: 10%; left: 10%; transform: translate(-50%, -50%); background-color: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 10px; display: block;">
      <p id="messageText" style="margin: 0;">Chuva iniciada!</p>
    </div>

    <script>
      AFRAME.registerComponent('rain-maker', {
        init: function () {
          var planeSize = 10;
          var numDrops = 500;
          var raining = true;

          // Função para iniciar ou parar a chuva
          function toggleRain() {
            raining = !raining;
            var rainDrops = document.querySelectorAll('[rain-drop]');
            rainDrops.forEach(function (drop) {
              var material = drop.getAttribute('material');
              if (raining) {
                material.opacity = 1; //Deixa as gotas com cor normal
              } else {
                material.opacity = 0; //Deixa as gotas transparentes
              }
              drop.setAttribute('material', material);
            });

            var messageText = document.getElementById('messageText');
            messageText.textContent = raining ? 'Chuva iniciada!' : 'Chuva parada!';
          }

          for (var i = 0; i < numDrops; i++) {
            var x = Math.random() * planeSize - (planeSize / 2);
            var y = Math.random() * 5 + 5; // Altura inicial variável
            var z = Math.random() * planeSize - (planeSize / 2);
            var speed = Math.random() * 2 + 1; // Velocidade variável

            //Cada gota é uma entidade esfera
            var rainDrop = document.createElement('a-entity');
            rainDrop.setAttribute('geometry', 'primitive: sphere; radius: 0.02');
            rainDrop.setAttribute('material', 'color: #7EC8E3; opacity: 1'); // Define a opacidade inicial
            rainDrop.setAttribute('position', { x: x, y: y, z: z });
            rainDrop.setAttribute('rain-drop', ''); // Adiciona um atributo para identificar gotas de chuva
            rainDrop.setAttribute('animation', {
              property: 'position',
              dur: 2000 + Math.random() * 3000, // Duração variável
              easing: 'linear',
              to: { x: x, y: -2, z: z },
              loop: true
            });

            //Atributo para queda da chuva
            rainDrop.setAttribute('animation__speed', {
              property: 'position',
              dur: 1000 / speed,
              easing: 'linear',
              to: { x: x, y: -2, z: z },
              loop: true
            });
            this.el.appendChild(rainDrop);
          }

          //Ouvinte para iniciar / parar chuva
          window.addEventListener('keydown', function (event) {
            if (event.key === 'r') {
              toggleRain();
            }
          });
        }
      });

      document.querySelector('#rain').setAttribute('rain-maker', '');
    </script>
  </a-scene>
</body>

</html>